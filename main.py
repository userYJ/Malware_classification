import pefile
import os


def load_train_csv():
    ret = {}

    fp = open('train.csv', 'r')
    while True:
        line = fp.readline()
        line = line.strip()
        if len(line) == 0:
            break
        hash, nclass = line.split(',')
        ret[hash] = nclass
    fp.close()

    return ret


def extract_info(filename):
    result = []

    pe = pefile.PE(filename)
    # print(pe)
    # sample로 pe 파일에서 특징 4개만 추출. 이 외에 다양한 특징 추출 필요
    result.append(pe.FILE_HEADER.SizeOfOptionalHeader) # 0xE0 / PE Header에서 원하는 값 추출
    result.append(pe.FILE_HEADER.Characteristics)  # PE Header 속성값
    result.append(pe.OPTIONAL_HEADER.MajorSubsystemVersion)
    result.append(pe.OPTIONAL_HEADER.MinorSubsystemVersion)

    try:
        result.append(pe.OPTIONAL_HEADER.BaseOfData)
    except AttributeError:
        result.append(0)

    # print(result)
    pe.close()
    return result


# MAIN
train_malware_hash = load_train_csv()

# Class - 악성 유무 판별
columns = [
    "SizeOfOptionalHeader",
    "Characteristics",
    "MajorSubsystemVersion",
    "MinorSubsystemVersion",
    "Class"
]

fp = open('train_data.csv', 'w')
msg = ','.join(columns)
fp.write(msg + '\n')

for name in os.listdir('./train'):
    try:
        print(name)
        ret = extract_info(f'./train/{name}')
        ret.append(train_malware_hash[name])

        # print(ret)
        # print(len(ret)) #속성 개수
        # CSV write
        k = [str(x) for x in ret]
        msg = ','.join(k)
        fp.write(msg + '\n')
    except:
        pass

fp.close()


