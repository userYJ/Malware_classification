import requests
from bs4 import BeautifulSoup
import tempfile
import hashlib
import shutil


def get_html(pg_no: int):
    url = f'https://urlhaus.abuse.ch/browse/page/{pg_no}/'
    res = requests.get(url)
    if res.status_code == 200:
        return res.content

    return None


def malware_download(url: str, i: int):
    try:
        res = requests.get(url, timeout=10)
        if res.status_code == 200:
            tname = tempfile.mktemp()
            open(tname, 'wb').write(res.content)

            fname = hashlib.sha256(res.content).hexdigest()
            print(fname)

            shutil.move(tname, fname)
    except:
        pass


for page in range(1, 2):
    html = get_html(page)
    soup = BeautifulSoup(html, 'html.parser')
    for i in range(1, 101):
        r = soup.select_one(f'body > main > table > tbody > tr:nth-child({i}) > td:nth-child(2) > a')
        print(r.text)   # 악성코드 url 주소
        malware_download(r.text, i)

